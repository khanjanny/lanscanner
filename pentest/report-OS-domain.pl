#!/usr/bin/env perl
use strict; 
use warnings;
use Data::Dumper;
no warnings 'uninitialized';

my $ip_list = $ARGV[0]; # IP list

open (SALIDA,">>../reports/OS-report.txt") || die "ERROR: No puedo abrir el fichero\n";
	print SALIDA "IP;NOMBRE;DOMINIO;S.O.;Server\n";
	close (SALIDA);

open (MYINPUT,"<$ip_list") || die "ERROR: Can not open the file $ip_list\n";
while (my $ip=<MYINPUT>)
{ 
$ip =~ s/\n//g; 
my $Server = '';
 # if (-e "$ip.txt")
  #{
	#Extraer nombre de equipo:
	my $name = `grep "Workstation Service" $ip.txt | awk '{print \$1}'`;
	$name =~ s/\n//g; 	
	
	#Extraer dominio/grupo de trabajo:
	my $domain = `grep "domain/workgroup name:" $ip.txt | cut -d : -f 2`;
	$domain =~ s/\n//g; 

	#my $content = `grep "OS=" $ip.txt`;

	my $OS = `nmap -n -Pn -p445 --script=smb-os-discovery $ip | grep --color=never "OS:"`;
	
	#$content =~ /OS=\[(.*?)\]/;
#	my $OS = $1;
	#$OS =~ s/Windows 5.1/Windows XP/g; 
		
	
	#$content =~ /Server=\[(.*?)\]/;
	#$Server = $1;
	
	open (SALIDA,">>../reports/OS-report.txt") || die "ERROR: No puedo abrir el fichero\n";
	print SALIDA "$ip;$name;$domain;$OS\n";
	close (SALIDA);
 # }
  #else
  #{print "$ip.txt does not exist\n";}
}
