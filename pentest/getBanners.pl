#!/usr/bin/env perl
use strict; 
use warnings;
use Data::Dumper;
use Getopt::Std;


my %opts;
getopts('l:t:u:', \%opts);

my $lista_ip = $opts{'l'} if $opts{'l'}; #todos los hosts vivos
my $archivo_escaneo_tcp = $opts{'t'} if $opts{'t'};


open (MYINPUT,"<$lista_ip") || die "ERROR: Can not open the file $lista_ip\n";
while (my $ip=<MYINPUT>)
{ 
$ip =~ s/\n//g;
$ip =~ s/ //g;


#Obtener lista de puertos abierto de la IP
#my $puertos_abiertos=`grep "$ip (" $archivo_escaneo_tcp | grep -o "[0-9][0-9]*/open" | tr '\\n' ',	' | tr -d '/open'`;
my $puertos_abiertos=`grep $ip $archivo_escaneo_tcp | cut -d ":" -f2 | tr "\n" ","`;

# Eliminar puertos con banners comunes
$puertos_abiertos =~ s/135,|445,|139,|49152,|49153,|49154,|49159,|49160,|49161,|9100,|8292,|8291,|2103,|1556,|2103,|2105,|2107,|3389,|3801,|3828,|5060,|6001,|3800,|1801,|808,|6002,|6004,|6005,|6006,|6007,|6009,|49155,|49156,|49157,|49158,|464,|593,|1037,|1039,|1044,|1045,|1056,//g; 

### Eliminar puertos repetidos
my @valores = split(',', $puertos_abiertos);
my %visto;
my @valores_unicos =   grep { !$visto{$_}++   } @valores; #puertos unicos
my $puertos_abiertos_unicos = join "," => @valores_unicos;
###############3

#chop($ports_open); # delete last char ','
if ($puertos_abiertos_unicos ne '')
{
	print "Escaneado los puertos: $puertos_abiertos_unicos en la IP: $ip \n";
	SCAN:	
	my $nmap_instances=`ps aux | grep nmap | wc -l` - 1;
	if ($nmap_instances < 6)
		{ 
		 system("nmap -sV -n -p $puertos_abiertos_unicos $ip -oG .escaneo_puertos_banners/$ip.grep >> .escaneo_puertos_banners/$ip.txt &");	}
	else
		{sleep 10; goto SCAN;}
	
	
}
#
}
