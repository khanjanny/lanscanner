#!/usr/bin/env perl
use strict; 
use warnings;
use Data::Dumper;
use Getopt::Std;


my %opts;
getopts('l:t:u:', \%opts);

my $ip_list = $opts{'l'} if $opts{'l'}; #all live hosts
my $scan_file_tcp = $opts{'t'} if $opts{'t'}; #all live hosts


open (MYINPUT,"<$ip_list") || die "ERROR: Can not open the file $ip_list\n";
while (my $ip=<MYINPUT>)
{ 
$ip =~ s/\n//g; 	


#my $ports_open = `grep "$ip ()" $scan_file | grep -o open/tcp | wc -l`;
my $ports_open=`grep "$ip (" $scan_file_tcp | grep -o "[0-9][0-9]*/open" | tr '\n' ',	' | tr -d '/open'`;
$ports_open =~ s/135,|445,|139,|49152,|49153,|49154,|49159,|49160,|49161,|9100,|8292,|8291,|2103,|1556,|2103,|2105,|2107,|3389,|3801,|3828,|5060,|6001,|3800,|1801,|808,|6002,|6004,|6005,|6006,|6007,|6009,|49155,|49156,|49157,|49158,|464,|593,|1037,|1039,|1044,|1045,|1056,//g; 



#chop($ports_open); # delete last char ','
if ($ports_open ne '')
{
	 SCAN:
	my $nmap_instances=`ps aux | grep nmap | wc -l` - 1;
	if ($nmap_instances < 6)
		{ print "Scanning ports $ports_open on $ip \n";
		 system("nmap -sV -n -p $ports_open $ip -oG .nmap_banners/$ip.grep >> .nmap_banners/$ip.txt &");	}
	else
		{sleep 10; goto SCAN;}
	
	
}
#
}
