#!/usr/bin/perl
use Data::Dumper;
use strict;
use utf8;
use Text::Unidecode;
binmode STDOUT, ":encoding(UTF-8)";
use LWP::UserAgent;
use Getopt::Long;
$ENV{PERL_LWP_SSL_VERIFY_HOSTNAME} = 0;

GetOptions(
    'host=s'    => \my $host,
    'port=i'     => \my $port,    
) or die usage();


sub usage { 
  
  print "Uso:  \n";
  print "Autor: Daniel Torres Sandi \n";
  print " owa.pl -host 192.168.0.2 -port 80 \n";  
}	



my $browser = LWP::UserAgent->new(ssl_opts => {
    verify_hostname => 0,
    SSL_cipher_list => '',
});

$browser->agent("Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:65.0) Gecko/20100101 Firefox/65.0");
$browser->timeout(25);
$browser->show_progress(1);

$ENV{PERL_LWP_SSL_VERIFY_HOSTNAME} = 0;


my $uri ;
if ($port == 80)
{
$uri = "http://$host";
}
else
{
$uri = "https://$host";
}



my $req = HTTP::Request->new( 'GET', $uri );
my $response = $browser->request( $req );
my $content = $response->decoded_content;



if ($content =~ /window.location.replace\("\/owa\/"/m){	 
	 
	$req = HTTP::Request->new( 'GET', "$uri/owa/" );
	$response = $browser->request( $req );
	$content = $response->decoded_content;
	 
 }
 



$content =~ /\/owa\/auth\/(.*?)\/themes\/resources\/favicon.ico/;
my $version = $1; 
print("version $version - ");

my @version_array = split('\.',$version);


my $major = @version_array[1];
my $minor = @version_array[2];

#print("major ($major) \n");
#print("minor ($minor) \n");

# Exchange Server 2013, fixed: 15.0.1497.6
if ($major == 0)
{
	if ($minor < 1497)
	{
		print("Exchange Server 2013 VULNERABLE \n");
	}
}


# Exchange Server 2016, fixed: 15.1.1847.7, 15.1.1913.7
if ($major == 1)
{
	if ($minor < 1913  && $minor != 1847)	
	{
		print("Exchange Server 2016 VULNERABLE \n");
	}
}

# Exchange Server 2019, fixed: 15.2.464.11, 15.2.529.8
if ($major == 2)
{
	if ($minor < 529  && $minor != 464)	
	{
		print("Exchange Server 2019 VULNERABLE \n");
	}
}
