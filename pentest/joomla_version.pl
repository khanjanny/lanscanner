#!/usr/bin/perl
use Getopt::Long;
use LWP::UserAgent;
use HTTP::Request;
$ENV{PERL_LWP_SSL_VERIFY_HOSTNAME} = 0;

GetOptions(
    'host=s'    => \my $host,
    'port=i'     => \my $port,    
    'path=s'     => \my $path,    
) or die usage();


sub usage { 
  
  print "Uso:  \n";
  print "Autor: Daniel Torres Sandi \n";
  print " joomla_servion.pl -host 192.168.0.2 -port 80 -path / \n";  
}	

my $browser = LWP::UserAgent->new;

$browser->timeout(5);
$browser->show_progress(0);
$browser->agent("Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko");


my $headers = HTTP::Headers->new;

#$headers->header('User-Agent' => $user_agent); 
#$browser->default_header('User-Agent' => $user_agent);

$headers->header('Accept-Language' => 'en-US,en;q=0.5'); 
$headers->header('Accept' => 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'); 
$headers->header('Connection' => 'keep-alive'); 
$headers->header('Accept-Encoding' => "gzip, deflat");

my $url1;
my $url2;

if ($port eq 443)
{
  $url1 = "https://$host:$port".$path."administrator/manifests/files/joomla.xml";   
}
else
{
  $url1 = "http://$host:$port".$path."administrator/manifests/files/joomla.xml";
}
#/v2/


my $req = HTTP::Request->new(GET => $url1, $headers);
$response = $browser->request($req);
my $content = $response->decoded_content;

$content =~ /<version>(.*?)</;
my $version = $1; 

if($version eq ""){	 
	if ($port eq 443)
		{
		$url2 = "https://$host:$port".$path."language/en-GB/en-GB.xml";   
		}
	else
		{
		$url2 = "http://$host:$port".$path."language/en-GB/en-GB.xml";
		}

$req = HTTP::Request->new(GET => $url2, $headers);
$response = $browser->request($req);
$content = $response->decoded_content;


$content =~ /<version>(.*?)</;
$version = $1;

}

 
if($version ne ""){	 
	 print "Joomla Core version: $version \n";
}
 
