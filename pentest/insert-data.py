#!/usr/bin/python
import time
import sqlite3
import datetime
import os, sys
import string
import os.path
import commands


date=datetime.date.today()


conn = sqlite3.connect('resultados.db')
c = conn.cursor()

#################  banners #######################
path = ".banners"
dirs = os.listdir( path )

# Insert enumeration of 
for file_name in dirs:   	
	line_array = file_name.split("_")  #192.168.0.1_21.txt 
		
	array_len = len(line_array)
	IP = line_array[0]
	PORT = line_array[1]
	PORT = PORT.replace(".txt", "")	# delete .txt	
	
	#print IP		
	#print PORT
	f = open(".banners/"+file_name, 'r')		
	enum=f.read()	
	enum = enum.replace("'", "")	# delete '  	
	f.close()
	if not enum or enum == "\n\n" or enum == "\n" : 
		print "Upps archivo vacio o es redireccion ",file_name
	else:		
		try:
			#print IP+" "+PORT+" "+TYPE+" "+enum
			c.execute("INSERT INTO BANNERS VALUES ('"+IP+"','"+PORT+"','"+enum+"')")		
			conn.commit()	
		except Exception as e:	
			print "Error al insertar datos !!!",file_name
			conn.rollback()
	
##########################################################


#################  enumeration #######################
path = ".enumeracion"
dirs = os.listdir( path )

# Insert enumeration of 
for file_name in dirs:   	
	line_array = file_name.split("_")  #192.168.0.1_smb_users.txt  #192.168.0.1_21.txt 
		
	array_len = len(line_array)
	IP = line_array[0]
	PORT = line_array[1]
	TYPE = ""
	if (array_len == 2):
		PORT = PORT.replace(".txt", "")	# delete .txt	
	else:
		TYPE = line_array[2]
		TYPE = TYPE.replace(".txt", "")	# delete .txt	

	#print IP		
	#print PORT
	f = open(".enumeracion/"+file_name, 'r')		
	enum=f.read()	
	enum = enum.replace("'", "")	# delete '  	
	f.close()
	if not enum or enum == "\n\n" or enum == "\n" or enum == ":" or enum == "Error" or "301 Moved" in enum or "302 Found" in enum  or "HTTPSredirect" in enum  or "Document Moved" in enum or "Cant connect" in enum or "403 Forbidden" in enum or "500 Status read failed" in enum or "Server closed connection" in enum : 
		print "Upps archivo vacio o es redireccion ",file_name
	else:		
		try:
			#print IP+" "+PORT+" "+TYPE+" "+enum
			c.execute("INSERT INTO ENUMERACION VALUES ('"+IP+"','"+PORT+"','"+TYPE+"','"+enum+"')")		
			conn.commit()	
		except Exception as e:	
			print "Error al insertar datos !!!",file_name
			conn.rollback()
	
##########################################################


#################  Vulnerabilities #######################
path = ".vulnerabilidades"
dirs = os.listdir( path )

# Insert enumeration of 
for file_name in dirs:   	
	print "name: "+file_name
	line_array = file_name.split("_")  #192.168.0.1_smb_users.txt  #192.168.0.1_21.txt 
		
	array_len = len(line_array)
	IP = line_array[0]
	PORT = line_array[1]
	TYPE = ""
	if (array_len == 2):
		PORT = PORT.replace(".txt", "")	# delete .txt	
	else:
		TYPE = line_array[2]
		TYPE = TYPE.replace(".txt", "")	# delete .txt	

	#print IP		
	#print PORT
	f = open(".vulnerabilidades/"+file_name, 'r')		
	vuln=f.read()	
	vuln = vuln.replace("'", "")	# delete '
	vuln = vuln.replace('"', '')	# delete "
	f.close()
	if not vuln or vuln == "\n\n" or vuln == "\n" or vuln == ":" :
		print "Upps empty file: ",file_name
	else:
		try:
			c.execute("INSERT INTO VULNERABILIDADES VALUES ('"+IP+"','"+PORT+"','"+TYPE+"','"+vuln+"')")		
			conn.commit()	
		except Exception as e:	
			print "Error al insertar datos !!!",file_name
			conn.rollback()
	
##########################################################

