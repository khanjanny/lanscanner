#!/usr/bin/python
import time
import sqlite3
import datetime
import os, sys
import string
import os.path
import commands


date=datetime.date.today()


conn = sqlite3.connect('results.db')
c = conn.cursor()

#################  enumeration #######################
path = "enumeration"
dirs = os.listdir( path )

# Insert enumeration of 
for file_name in dirs:   	
	line_array = file_name.split("-")  #192.168.0.1-smb-users.txt  #192.168.0.1-21.txt 
		
	array_len = len(line_array)
	IP = line_array[0]
	PROTOCOL = line_array[1]
	TYPE = ""
	if (array_len == 2):
		PROTOCOL = PROTOCOL.replace(".txt", "")	# delete .txt	
	else:
		TYPE = line_array[2]
		TYPE = TYPE.replace(".txt", "")	# delete .txt	

	#print IP		
	#print PROTOCOL
	f = open("enumeration/"+file_name, 'r')		
	enum=f.read()	
	enum = enum.replace("'", "")	# delete '  	
	f.close()
	if not enum or enum == "\n\n" or enum == "\n" or enum == ":" or enum == "Error" :
		print "Upps archivo vacio: ",file_name
	else:		
		try:
			c.execute("INSERT INTO ENUMERATION VALUES ('"+IP+"','"+PROTOCOL+"','"+TYPE+"','"+enum+"')")		
			conn.commit()	
		except Exception as e:	
			conn.rollback()
	
##########################################################


#################  Vulnerabilities #######################
path = "vulnerabilities"
dirs = os.listdir( path )

# Insert enumeration of 
for file_name in dirs:   	
	line_array = file_name.split("-")  #192.168.0.1-smb-users.txt  #192.168.0.1-21.txt 
		
	array_len = len(line_array)
	IP = line_array[0]
	PORT = line_array[1]
	TYPE = ""
	if (array_len == 2):
		PORT = PORT.replace(".txt", "")	# delete .txt	
	else:
		TYPE = line_array[2]
		TYPE = TYPE.replace(".txt", "")	# delete .txt	

	#print IP		
	#print PROTOCOL
	f = open("vulnerabilities/"+file_name, 'r')		
	vuln=f.read()	
	vuln = vuln.replace("'", "")	# delete '
	vuln = vuln.replace('"', '')	# delete "
	f.close()
	if not vuln or vuln == "\n\n" or vuln == "\n" or vuln == ":" :
		print "Upps empty file: ",file_name
	else:
		try:
			c.execute("INSERT INTO VULNERABILITIES VALUES ('"+IP+"','"+PORT+"','"+TYPE+"','"+vuln+"')")		
			conn.commit()	
		except Exception as e:	
			conn.rollback()
	
##########################################################

