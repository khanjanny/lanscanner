#!/usr/bin/env perl
use strict; 
use warnings;
use Data::Dumper;
use Math::Round;

my $max_file_size = $ARGV[0];
my $destination_dir = $ARGV[1]; # where should I save the shared resources

my $limit_size = $max_file_size*1024*1024; # 100mb
$destination_dir =~ s/\n//g; # remove new line


#### procesing shared names
my $shares = `grep -i disk * | grep -v '\$|' | grep -v "\$ip ="`; # get shared resources

my @line_array = split("\n",$shares);

foreach (@line_array)
{
  print "\n \t $_ \n";
  my @shared_array =  split(/\|/, $_);
  my $ip = $shared_array[0];
  $ip =~ s/.txt:Disk//g; # 
  my $shared_name = $shared_array[1];
  $shared_name =~ s/ /\\ /g; # escape spaces
  sleep 1;
  print "\t##### Copying from $ip ##### \n";
  
  system("mkdir -p $ip");
  
  print "\t +Resource: $shared_name \n";
  system("umount /mnt/hgfs/ 2>/dev/null");
  system("mount.cifs //$ip/"."$shared_name/ /mnt/hgfs/ -o guest");
  my @dir_content = </mnt/hgfs/*>;
  
  ### Copy each file/folder###
  foreach my $file (@dir_content) {
	my $size;
    $file =~ s/ /\\ /g;# escape spaces
    $file =~ s/\(/\\(/g;# escape (
    $file =~ s/\)/\\)/g;# escape )
    #print "\t\tusing file $file \n";
    my $destination = $destination_dir."/".$ip."/".$shared_name;
    
    my $file_line = `ls -lh $file | head -1`;
    
    if($file_line =~ /total/m){
	  # it's a directory
	  $size = `ls -l $file | head -1 | cut -d " " -f 2`;
	  $size = $size*1024;
	}
	else
   {
	   $size = `ls -l $file | cut -d " " -f 5`;
   }
    
    my $sizeMb = nearest(.01, $size/1048576);
    
   
   if ($size > $limit_size )
   {	 
	 {print "\t \t \t Upps archivo muy grande ($file) \n";}
   }
	elsif ($file =~ /.exe|.msi|driver/i)
	{	  
	    {print "\t \t \t No me interesa copiar instaladores ($file) \n";}
	 }
	 elsif (($file =~ /video|foto|musica/i))
	 {print "\t \t \t Encontre multimedia, no copio eso!  ($file)  \n";}
	 else
	 {
	   print "\t \t ++ Copiando $file ($sizeMb Mb) \n";
	   system ("mkdir -p $destination");
       system("cp -r $file $destination");
	 }      
    
  }
}


