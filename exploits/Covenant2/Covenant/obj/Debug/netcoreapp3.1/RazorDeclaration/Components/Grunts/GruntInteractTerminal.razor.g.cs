#pragma checksum "/root/nk/Github/lanscanner/exploits/Covenant/Covenant/Components/Grunts/GruntInteractTerminal.razor" "{ff1816ec-aa5e-4d10-87f7-6f4963833460}" "9d2be95530243fb08f78cf44a651752b41ffc844"
// <auto-generated/>
#pragma warning disable 1591
#pragma warning disable 0414
#pragma warning disable 0649
#pragma warning disable 0169

namespace Covenant.Components.Grunts
{
    #line hidden
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
#nullable restore
#line 1 "/root/nk/Github/lanscanner/exploits/Covenant/Covenant/Components/_Imports.razor"
using Microsoft.AspNetCore.Components;

#line default
#line hidden
#nullable disable
#nullable restore
#line 2 "/root/nk/Github/lanscanner/exploits/Covenant/Covenant/Components/_Imports.razor"
using Microsoft.AspNetCore.Components.Web;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "/root/nk/Github/lanscanner/exploits/Covenant/Covenant/Components/_Imports.razor"
using Microsoft.AspNetCore.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "/root/nk/Github/lanscanner/exploits/Covenant/Covenant/Components/_Imports.razor"
using Covenant.Models;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "/root/nk/Github/lanscanner/exploits/Covenant/Covenant/Components/Grunts/GruntInteractTerminal.razor"
using Microsoft.JSInterop;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "/root/nk/Github/lanscanner/exploits/Covenant/Covenant/Components/Grunts/GruntInteractTerminal.razor"
using Microsoft.AspNetCore.SignalR;

#line default
#line hidden
#nullable disable
#nullable restore
#line 7 "/root/nk/Github/lanscanner/exploits/Covenant/Covenant/Components/Grunts/GruntInteractTerminal.razor"
using Covenant.Core;

#line default
#line hidden
#nullable disable
#nullable restore
#line 8 "/root/nk/Github/lanscanner/exploits/Covenant/Covenant/Components/Grunts/GruntInteractTerminal.razor"
using Covenant.Hubs;

#line default
#line hidden
#nullable disable
#nullable restore
#line 9 "/root/nk/Github/lanscanner/exploits/Covenant/Covenant/Components/Grunts/GruntInteractTerminal.razor"
using Covenant.Models.Grunts;

#line default
#line hidden
#nullable disable
    public partial class GruntInteractTerminal : OwningComponentBase<ICovenantService>, IDisposable
    {
        #pragma warning disable 1998
        protected override void BuildRenderTree(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder __builder)
        {
        }
        #pragma warning restore 1998
#nullable restore
#line 48 "/root/nk/Github/lanscanner/exploits/Covenant/Covenant/Components/Grunts/GruntInteractTerminal.razor"
       
    [Parameter]
    public Grunt Grunt { get; set; }
    private IList<GruntCommand> GruntCommands { get; set; }

    [Parameter]
    public EventCallback<Tuple<Grunt, string>> OnInteract { get; set; }

    private string GuidId { get; set; } = "a" + Utilities.CreateShortGuid();

    private GruntTaskOptionsModal OptionsModal { get; set; }

    private int HistoryIndex { get; set; }
    private IList<GruntCommand> History { get; set; }
    private string HistorySavedState { get; set; } = string.Empty;
    private string InteractInput { get; set; } = string.Empty;
    private IEnumerable<string> Suggestions { get; set; }

    protected override async Task OnInitializedAsync()
    {
        this.GruntCommands = (await Service.GetGruntCommandsForGrunt(this.Grunt.Id)).ToList();
        this.History = this.GruntCommands.OrderBy(GC => GC.CommandTime).ToList();
        this.HistoryIndex = this.History.Count;
        this.Suggestions = await Service.GetCommandSuggestionsForGrunt(this.Grunt);
        Service.DisposeContext();
        this.INotificationService.OnCreateGruntCommand += OnCreateGruntCommand;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await IJSRuntime.InvokeAsync<string>("InitializeTypeahead", $"#{GuidId}.typeahead", this.Suggestions);
        }
    }

    public void Dispose()
    {
        this.INotificationService.OnCreateGruntCommand -= OnCreateGruntCommand;
    }

    private async void OnCreateGruntCommand(object sender, GruntCommand gruntCommand)
    {
        if (this.Grunt.Id == gruntCommand.GruntId)
        {
            this.GruntCommands = (await Service.GetGruntCommandsForGrunt(this.Grunt.Id)).ToList();
            Service.DisposeContext();
            this.History = this.GruntCommands.OrderBy(GC => GC.CommandTime).ToList();
            this.HistoryIndex = this.History.Count;
            await this.InvokeAsync(() => this.StateHasChanged());
        }
    }

    private void HistoryUp()
    {
        bool updated = false;
        if (this.HistoryIndex == this.History.Count && this.InteractInput != string.Empty)
        {
            this.HistorySavedState = this.InteractInput;
        }
        else if (this.HistoryIndex == this.History.Count && this.InteractInput == string.Empty && this.HistorySavedState != string.Empty)
        {
            this.InteractInput = this.HistorySavedState;
            updated = true;
        }
        if (this.HistoryIndex != 0)
        {
            if (!updated)
            {
                this.HistoryIndex--;
                this.InteractInput = this.History[this.HistoryIndex].Command;
            }
            this.StateHasChanged();
            _ = IJSRuntime.InvokeAsync<string>("SetTypeaheadVal", $"#{GuidId}.typeahead", this.InteractInput);
        }
    }

    private void HistoryDown()
    {
        if (this.HistoryIndex < (this.History.Count - 1))
        {
            this.HistoryIndex++;
            this.InteractInput = this.History[this.HistoryIndex].Command;
            this.StateHasChanged();
            _ = IJSRuntime.InvokeAsync<string>("SetTypeaheadVal", $"#{GuidId}.typeahead", this.InteractInput);
        }
        else if (this.HistoryIndex == (this.History.Count - 1))
        {
            this.HistoryIndex++;
            this.InteractInput = this.HistorySavedState;
            this.StateHasChanged();
            _ = IJSRuntime.InvokeAsync<string>("SetTypeaheadVal", $"#{GuidId}.typeahead", this.InteractInput);
        }
        else if (this.HistoryIndex == this.History.Count && this.InteractInput != string.Empty)
        {
            this.HistorySavedState = this.InteractInput;
            this.InteractInput = string.Empty;
            this.StateHasChanged();
            _ = IJSRuntime.InvokeAsync<string>("SetTypeaheadVal", $"#{GuidId}.typeahead", this.InteractInput);
        }
    }

    private void OnSetInteractInput(ChangeEventArgs e)
    {
        this.InteractInput = e.Value.ToString();
        _ = IJSRuntime.InvokeAsync<string>("ClearSelectedTypeaheadVal");
    }

    private async Task OnKeyUp(KeyboardEventArgs e)
    {
        switch (e.Key)
        {
            case "ArrowUp":
                bool hasSuggestions = await IJSRuntime.InvokeAsync<bool>("TypeAheadHasSuggestions", $"#{GuidId}.typeahead");
                if (!hasSuggestions)
                {
                    HistoryUp();
                }
                break;
            case "ArrowDown":
                HistoryDown();
                break;
            case "Enter":
                string val = await IJSRuntime.InvokeAsync<string>("GetSelectedTypeaheadVal", $"#{GuidId}.typeahead");
                if (! string.IsNullOrWhiteSpace(val))
                {
                    this.InteractInput = val;
                }
                await this.OnSubmit();
                break;
        }
    }

    private async Task OnSubmit()
    {
        string copy = this.InteractInput;
        this.InteractInput = "";
        this.StateHasChanged();

        List<ParsedParameter> parameters = ParsedParameter.GetParsedCommandParameters(copy);
        string commandName = parameters.Count > 0 ? parameters.FirstOrDefault().Value : "";
        GruntTask commandTask = null;
        try
        {
            commandTask = await Service.GetGruntTaskByName(commandName, this.Grunt.DotNetVersion);
            Service.DisposeContext();
            string errors = await Service.ParseParametersIntoTask(commandTask, parameters);
            Service.DisposeContext();
        }
        catch (ControllerNotFoundException) { }
        if (commandTask != null && commandTask.Options.Any(O => O.FileOption))
        {
            await OptionsModal.Show(commandTask);
        }
        else
        {
            this.OnInteractProxy(copy);
        }
    }

    private void OnTaskInteract(GruntTask task)
    {
        this.OnInteractProxy(task.GetVerboseCommand(true));
    }

    private void OnInteractProxy(string input)
    {
        _ = OnInteract.InvokeAsync(new Tuple<Grunt, string>(this.Grunt, input));
        _ = IJSRuntime.InvokeAsync<string>("SetTypeaheadVal", $"#{GuidId}.typeahead", this.InteractInput);
    }

#line default
#line hidden
#nullable disable
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private INotificationService INotificationService { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IHubContext<EventHub> EventHub { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IHubContext<GruntHub> GruntHub { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IJSRuntime IJSRuntime { get; set; }
    }
}
#pragma warning restore 1591
